# hakaton-flagman
# Описание системы инвентаризации

## Общее описание

Система инвентаризации состоит из трёх компонентов:
1. **Веб-приложение (Frontend)** - React приложение для управления документами инвентаризации
2. **Backend API** - ASP.NET Core Web API для обработки данных
3. **Мобильное приложение** - Android приложение для сканирования и работы с данными

## Как работает система

### 1. Авторизация

**Веб-приложение:**
- Пользователь открывает страницу логина
- Вводит email и пароль (по умолчанию: `admin@test.com` / `123456`)
- Получает JWT токен, который сохраняется в localStorage
- Токен используется для всех последующих запросов к API

### 2. Создание документа инвентаризации

**Веб-приложение:**
- Пользователь нажимает кнопку "Создать документ" на главной странице (Dashboard)
- Система автоматически создаёт новый документ с именем "Инвентаризация <дата>"
- Документ создаётся без привязки к организации (organizationId = null)
- Документ отображается в списке на главной странице

### 3. Добавление позиций в документ

Есть два способа добавить позиции (items) в документ:

#### Способ 1: Импорт из текстового файла (блокнота)

**Процесс:**
1. Пользователь открывает документ (кликает на него в списке)
2. Нажимает кнопку "Импорт из файла"
3. Выбирает текстовый файл (.txt) с данными в формате:
   ```
   111 ааа
   222 ббб
   333 ввв
   ```
   Или просто название:
   ```
   ааа
   ббб
   ```
   Где первое значение - штрихкод, второе - название товара (или только название)
4. Система парсит файл, подсчитывает количество каждого товара и добавляет позиции в документ
5. Если один товар встречается несколько раз в файле, он объединяется в одну позицию
6. Позиции отображаются в таблице документа

**Backend:**
- Endpoint: `POST /api/Items/import`
- Принимает: `{ documentId, textData }`
- Парсит строки, подсчитывает количество каждого штрихкода
- Создаёт items с barcode и name
- **Plan и Fact устанавливаются равными количеству товара в файле** (если товар встречается 3 раза → plan=3, fact=3)
- Статус автоматически становится ✅ (зелёная галочка), так как plan = fact

#### Способ 2: Через сканирование QR кодов с товаров (основной способ)

**Процесс:**
1. **Генерация QR кодов для товаров:**
   - На сайте [qr-online.ru](https://qr-online.ru/#text) генерируются QR коды
   - Каждый QR код содержит штрихкод товара (например: `111`)
   - QR коды распечатываются и клеятся на товары

2. **Сканирование QR кодов:**
   - Мобильное приложение сканирует QR коды с товаров
   - Каждый отсканированный штрихкод сохраняется в txt файл
   - Формат файла: каждая строка = один отсканированный штрихкод
   ```
   111
   111
   222
   111
   ```

3. **Отправка результатов на сервер:**
   - Мобильное приложение отправляет txt файл на сервер
   - Endpoint: `POST /api/Items/scan-results`
   - Сервер подсчитывает количество каждого штрихкода
   - Обновляет `fact` (фактическое количество) в БД
   - Сравнивает `plan` (план) с `fact` (факт)

4. **Результат:**
   - На веб-сайте видно обновлённые данные
   - Статус показывает: ✅ если план = факт, ❌ если не совпадают

#### Способ 3: Генерация QR кода документа для передачи данных

**Процесс:**
1. Пользователь открывает документ на веб-сайте
2. Нажимает кнопку "Показать QR код"
3. Открывается модальное окно с QR кодом, содержащим:
   - ID документа
   - Список всех позиций документа (barcode, name, plan, fact)
4. Мобильное приложение сканирует QR код
5. Мобильное приложение получает данные документа для работы

### 4. Работа с позициями в документе

**Веб-приложение:**
- При открытии документа загружаются все позиции (items)
- Позиции отображаются в таблице:
  - Наименование (name)
  - План (plan) - плановое количество
  - Факт (fact) - фактическое количество (можно редактировать)
  - Статус (✅ если plan = fact, ❌ если не совпадают)
- Пользователь может изменить значение "Факт" прямо в таблице
- Изменения сохраняются автоматически через API

**Backend:**
- `GET /api/Items/document/{documentId}` - получить все позиции документа
- `PATCH /api/Items/{id}/fact` - обновить фактическое количество

### 5. Удаление документа

**Веб-приложение:**
- На главной странице у каждого документа есть кнопка "Удалить"
- При нажатии появляется подтверждение
- После подтверждения документ и все его позиции удаляются из БД
- Документ исчезает из списка

**Backend:**
- `DELETE /api/Documents/{id}` - удаляет документ и все связанные items

## Структура данных

### Document (Документ)
- `id` - уникальный идентификатор (GUID)
- `name` - название документа
- `organizationId` - ID организации (может быть null)
- `createdAt` - дата создания
- `items` - список позиций в документе

### Item (Позиция)
- `id` - уникальный идентификатор (GUID)
- `documentId` - ID документа, к которому относится позиция
- `barcode` - штрихкод товара
- `name` - название товара
- `plan` - плановое количество
- `fact` - фактическое количество

## API Endpoints

### Documents
- `GET /api/Documents` - получить все документы
- `GET /api/Documents/{id}` - получить документ по ID
- `POST /api/Documents` - создать документ
- `DELETE /api/Documents/{id}` - удалить документ

### Items
- `GET /api/Items` - получить все позиции
- `GET /api/Items/{id}` - получить позицию по ID
- `GET /api/Items/document/{documentId}` - получить позиции документа
- `POST /api/Items` - создать позицию
- `POST /api/Items/import` - импортировать позиции из текстового файла
  - Подсчитывает количество каждого товара в файле
  - Устанавливает `plan` и `fact` равными количеству
- `POST /api/Items/scan-results` - обработать результаты сканирования QR кодов
  - Принимает txt файл с отсканированными штрихкодами
  - Подсчитывает количество каждого штрихкода
  - Обновляет `fact` в БД
  - Сравнивает `plan` и `fact`, возвращает результаты
- `PATCH /api/Items/{id}/fact` - обновить фактическое количество

### Auth
- `POST /auth/login` - авторизация (получить токен)

## Типичный сценарий использования

### Сценарий 1: Импорт и ручное обновление

1. **Пользователь входит в систему** через веб-приложение
2. **Создаёт новый документ** инвентаризации
3. **Импортирует данные** из текстового файла
   - Товары создаются с `plan` и `fact` равными количеству в файле
   - Статус автоматически ✅ (зелёная галочка)
4. **Открывает документ** и видит список позиций
5. **Обновляет фактические значения** (fact) вручную, если нужно
6. **При необходимости удаляет документ** после завершения инвентаризации

### Сценарий 2: Сканирование QR кодов (основной)

1. **Пользователь входит в систему** через веб-приложение
2. **Создаёт новый документ** инвентаризации
3. **Импортирует список товаров** из текстового файла (создаёт позиции в БД)
4. **Генерирует QR коды** на [qr-online.ru](https://qr-online.ru/#text) для каждого товара
5. **Клеит QR коды** на товары
6. **Сканирует QR коды** мобильным приложением
7. **Мобильное приложение отправляет** txt файл с отсканированными штрихкодами на сервер
8. **Сервер обрабатывает** результаты:
   - Подсчитывает количество каждого штрихкода
   - Обновляет `fact` в БД
   - Сравнивает `plan` и `fact`
9. **На веб-сайте видно** результаты сравнения:
   - ✅ если план = факт
   - ❌ если план ≠ факт (недостаточно или избыточно)
10. **При необходимости удаляет документ** после завершения инвентаризации

## Особенности работы

### Импорт товаров
- При импорте система автоматически подсчитывает количество каждого товара в файле
- Если товар встречается несколько раз, он объединяется в одну позицию
- `plan` и `fact` устанавливаются равными количеству товара в файле
- Статус автоматически становится ✅ (зелёная галочка), так как plan = fact

### Сканирование QR кодов
- Мобильное приложение сканирует QR коды с товаров
- Каждый отсканированный штрихкод сохраняется в txt файл
- При отправке на сервер система подсчитывает количество каждого штрихкода
- Обновляет `fact` (фактическое количество) в БД
- Сравнивает с `plan` (плановое количество) и показывает статус

### Статусы сравнения
- ✅ **"совпадает"** - план = факт
- ❌ **"недостаточно"** - факт < план (не хватает товара)
- ⚠️ **"избыточно"** - факт > план (больше чем планировалось)

### Обработка ошибок
- Улучшена обработка ответов от API
- Если документ пустой (нет позиций), показывается сообщение "Нет позиций в документе" вместо ошибки
- Ошибки 401 (не авторизован) обрабатываются автоматически с редиректом на логин

## Технические детали

### Frontend
- React + TypeScript
- Chakra UI для компонентов
- React Router для навигации
- QR код генерируется библиотекой `react-qr-code`

### Backend
- ASP.NET Core 8.0
- Entity Framework Core с SQLite
- JWT авторизация
- RESTful API

### База данных
- SQLite (файл `database.db`)
- Автоматическое применение миграций при запуске

